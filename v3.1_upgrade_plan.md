# 游戏助手 3.1 版本升级计划

## 📋 升级需求概述

基于3.0版本的成功运行，3.1版本将重点优化存储管理、性能和配置灵活性：

1. **截图自动清理机制** - 只保留最近3次截图，节省存储空间
2. **VLM识别效率优化** - 提升分析速度和准确性
3. **提示词配置化** - 将硬编码的提示词提取到配置文件

## 🎯 详细实现方案

### 1. 截图自动清理机制

#### 1.1 设计思路
- 在每次保存新截图时，自动清理旧截图
- 保留最近N次截图（默认3次，可配置）
- 支持按时间戳排序，确保清理最旧的文件
- 提供手动清理接口

#### 1.2 配置项新增
```yaml
screenshot:
  max_keep_count: 3  # 最大保留截图数量
  auto_cleanup: true  # 是否自动清理
  cleanup_pattern: "screenshot_*,analysis_*,auto_screenshot_*"  # 清理文件模式
```

#### 1.3 实现位置
- `src/utils/screenshot.py` - 添加清理逻辑
- `src/utils/config.py` - 添加配置项
- `src/services/async_analysis_manager.py` - 集成清理机制

### 2. VLM识别效率优化

#### 2.1 优化策略
- **图像预处理优化**：智能裁剪、去噪、对比度增强
- **提示词优化**：更精确的指令，减少无关输出
- **缓存机制**：相似截图结果缓存
- **并发处理**：多任务并行分析
- **模型参数调优**：temperature、top_p等参数优化

#### 2.2 配置项扩展
```yaml
vision:
  ollama_config:
    # 现有配置...
    temperature: 0.1  # 降低随机性，提高一致性
    top_p: 0.9
    num_predict: 512  # 限制输出长度
    
  optimization:
    enable_preprocessing: true  # 启用图像预处理
    enable_caching: true  # 启用结果缓存
    cache_similarity_threshold: 0.95  # 相似度阈值
    max_cache_size: 100  # 最大缓存条目
```

#### 2.3 实现位置
- `src/services/ollama_vlm.py` - 核心优化逻辑
- `src/utils/image_processor.py` - 新增图像预处理模块
- `src/utils/cache_manager.py` - 新增缓存管理模块

### 3. 提示词配置化

#### 3.1 设计思路
- 将所有硬编码提示词提取到配置文件
- 支持多语言提示词
- 支持运行时动态加载
- 支持用户自定义提示词

#### 3.2 配置文件结构
```yaml
prompts:
  game_analysis:
    zh: |
      你是一个专业的三国志战略版游戏助手...
    en: |
      You are a professional Three Kingdoms strategy game assistant...
  
  ui_elements:
    zh: |
      请仔细分析这张游戏截图中的所有UI元素...
    en: |
      Please carefully analyze all UI elements in this game screenshot...
  
  action_suggestion:
    zh: |
      基于当前游戏状态，请提供最优的操作建议...
    en: |
      Based on the current game state, please provide optimal action suggestions...
  
  # 用户自定义提示词
  custom:
    my_prompt: |
      自定义提示词内容...
```

#### 3.3 实现位置
- `resources/prompts.yaml` - 新增提示词配置文件
- `src/utils/prompt_manager.py` - 新增提示词管理器
- `src/services/ollama_vlm.py` - 修改为从配置加载提示词

## 🔧 实现步骤

### 阶段1：截图清理机制（优先级：高）
1. 扩展配置类，添加截图管理配置
2. 实现截图清理逻辑
3. 集成到现有保存流程
4. 测试验证

### 阶段2：提示词配置化（优先级：高）
1. 创建提示词配置文件
2. 实现提示词管理器
3. 修改VLM服务加载逻辑
4. 测试多语言支持

### 阶段3：VLM效率优化（优先级：中）
1. 实现图像预处理模块
2. 添加结果缓存机制
3. 优化模型参数
4. 性能测试和调优

## 📊 预期效果

### 存储优化
- **空间节省**：截图文件减少70%+（只保留3次vs无限制）
- **管理简化**：自动清理，无需手动维护

### 性能提升
- **分析速度**：预期提升30-50%
- **准确性**：通过优化提示词和预处理提升10-20%
- **响应时间**：缓存机制减少重复分析时间

### 配置灵活性
- **可维护性**：提示词独立配置，易于调整
- **多语言支持**：支持中英文切换
- **用户定制**：支持自定义提示词

## 🧪 测试计划

### 功能测试
- 截图清理机制测试
- 提示词加载测试
- VLM优化效果测试

### 性能测试
- 分析速度对比测试
- 内存使用监控
- 存储空间使用测试

### 兼容性测试
- 配置向后兼容性
- 多语言环境测试
- 异常情况处理测试

## 📝 开发注意事项

1. **向后兼容**：确保现有配置文件仍可正常工作
2. **错误处理**：优雅处理配置文件缺失或格式错误
3. **性能监控**：添加性能指标收集
4. **文档更新**：同步更新用户文档和配置说明
5. **渐进式部署**：支持功能开关，可逐步启用新特性

---

**版本**: 3.1  
**计划完成时间**: 即时开发  
**负责人**: AI Assistant  
**状态**: 设计完成，准备实施